# Tool Flows — Адаптивный слой между LLM и инструментами

## Идея

Каждый "толстый" инструмент (entities, activities, customers, etc.) оборачивается в **Flow**, который:

1. Принимает типизированный input от главного агента
2. Решает, как выполнить операцию — **напрямую** или через **sub-agent**

## Режимы работы (Mode)

```
┌─────────────┐
│ Main Agent  │
└──────┬──────┘
       │ mode?
       ▼
┌──────────────────────────────────────┐
│              Tool Flow               │
│                                      │
│  mode=direct    │   mode=complex     │
│  ───────────    │   ─────────────    │
│  Прямой вызов   │   Sub-agent        │
│  SDK операции   │   (Gemini Flash)   │
│                 │   → reasoning      │
│                 │   → SDK операции   │
└──────────────────────────────────────┘
```

### `mode=direct`
- Главный агент передаёт **полные данные** для выполнения
- Flow просто маршрутизирует вызов в SDK
- **Когда использовать:** простые CRUD операции с известными ID и данными
- **Пример:** "Получить сделку 12345", "Создать контакт с именем Иван"

### `mode=complex`
- Главный агент передаёт **намерение** (intent) и контекст
- Flow передаёт это специализированному sub-agent (Flash)
- Sub-agent сам решает какие SDK операции выполнить
- **Когда использовать:** batch-операции, условная логика, multi-step сценарии
- **Пример:** "Создай задачи для всех просроченных сделок", "Обнови статус сделок менеджера Иванова"

## Преимущества

| Аспект | Выгода |
|--------|--------|
| **Экономия** | Простые операции = 1 LLM вызов, без лишних токенов |
| **Гибкость** | Сложные сценарии обрабатываются умным sub-agent |
| **Упрощение Main Agent** | Не нужно учить модель сложным схемам со всеми полями |
| **Специализация** | Каждый sub-agent знает свой домен и API |

## Структура input

```
FlowInput:
├── mode: "direct" | "complex"
│
├── [mode=direct]
│   ├── action: "get" | "create" | "update" | ...
│   ├── id: int
│   ├── data: типизированные данные
│   └── filter: типизированные фильтры
│
└── [mode=complex]
    ├── intent: описание намерения
    └── context: дополнительный контекст (сущности, условия)
```

## Принцип

> Главный агент — роутер, который оценивает сложность запроса.
> Tool Flow — исполнитель, который знает как сделать работу.

## Архитектура видимости

```
┌────────────────────────────────────────────────────────────┐
│                    Main Chat Agent                         │
│                                                            │
│  Видит ТОЛЬКО Tool Flows:                                  │
│  • entities_flow                                           │
│  • activities_flow                                         │
│  • customers_flow                                          │
│  • ...                                                     │
│                                                            │
│  НЕ видит прямые SDK-инструменты!                          │
└────────────────────────────────────────────────────────────┘
                           │
                           │ mode + упрощённые данные
                           ▼
┌────────────────────────────────────────────────────────────┐
│                      Tool Flow                             │
│                                                            │
│  ┌─────────────────┐    ┌──────────────────────────┐       │
│  │  mode=direct    │    │     mode=complex         │       │
│  │  ────────────   │    │     ─────────────        │       │
│  │  Прямой вызов   │    │     Sub-Agent (Flash)    │       │
│  │  SDK операций   │    │     с доменным промптом  │       │
│  └────────┬────────┘    └────────────┬─────────────┘       │
│           │                          │                      │
│           ▼                          ▼                      │
│  ┌─────────────────────────────────────────────────┐       │
│  │              SDK Adapters                        │       │
│  │  SearchLeads, CreateTask, UpdateContact, ...    │       │
│  │                                                  │       │
│  │  (Невидимы для Main Agent!)                      │       │
│  └─────────────────────────────────────────────────┘       │
└────────────────────────────────────────────────────────────┘
```

### Что это даёт

| Аспект | Было (прямые tools) | Стало (через flows) |
|--------|---------------------|---------------------|
| Схема для Main Agent | 30+ полей на инструмент | 6-7 полей на flow |
| Знание API | Main Agent должен знать все детали | Main Agent знает только mode + базовые данные |
| Сложная логика | В Main Agent | В Sub-Agent внутри Flow |
| Токены | Огромные JSON Schema | Компактные схемы |

### Упрощённый Input для Main Agent

```
FlowInput (что видит Main Agent):
├── mode: "direct" | "complex"
├── entity_type: "leads" | "contacts" | ...
│
├── [mode=direct]
│   ├── action: "get" | "create" | "update"
│   ├── id: int (опционально)
│   └── data: any (упрощённые данные)
│
└── [mode=complex]
    └── intent: "описание намерения на естественном языке"
```

Вместо детальных структур с 30+ полями — простая маршрутизация.

---

## Текущий статус

Структуры FlowInput уже определены в [`internal/models/flows/`](file:///Users/tihn/amo-ai-tgbot-go/internal/models/flows):

- `base.go` — `FlowMode` (direct/complex), `BaseFlowInput`
- `entities.go` — `EntitiesFlowInput` (упрощённый input для entities flow)

## TODO

- [x] Определить структуры FlowInput для каждого домена
- [ ] Реализовать базовый Flow с mode-routing
- [ ] Написать промпты для sub-agents
- [ ] Протестировать на реальных сценариях