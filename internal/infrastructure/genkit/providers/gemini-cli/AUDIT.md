# Аудит Genkit-провайдера `gemini-cli`: Список проблем

В ходе аудита Go-реализации провайдера `gemini-cli` выявлены следующие критические недостатки и функциональные пробелы, требующие исправления.

## 1. Критические ошибки (Critical)

### 1.1. Потеря обновленных токенов (Token Persistence)
**Файл**: `internal/infrastructure/genkit/providers/gemini-cli/oauth.go`

**Проблема**:
Функция `GetTokenSource` создает стандартный `oauth2.TokenSource`, который обновляет Access Token в памяти при его истечении, но **не сохраняет** новые токены (включая потенциально ротированный Refresh Token) обратно на диск.

**Риск**:
При перезапуске приложение использует старый (возможно, уже невалидный) токен с диска. Потеря актуального Refresh Token приведет к полной потере доступа и необходимости повторной ручной авторизации пользователя.

**Рекомендация**:
Реализовать кастомный механизм `TokenSource`, который вызывает `SaveToken` при каждом успешном обновлении токена.

### 1.2. Hardcoded Platform Value
**Файл**: `internal/infrastructure/genkit/providers/gemini-cli/client.go`

**Проблема**:
В метаданных клиента жестко прописано значение платформы:
```go
Platform: "DARWIN_ARM64"
```

**Риск**:
Некорректная идентификация окружения на Linux/Windows или Intel-Mac системах. Может привести к получению неправильных конфигураций от сервера или ошибкам в аналитике.

**Рекомендация**:
Использовать `runtime.GOOS` и `runtime.GOARCH` для динамического определения платформы.

## 2. Функциональные пробелы (Gaps)

### 2.1. Отсутствие Телеметрии (Telemetry)
**Проблема**:
В отличие от TypeScript-версии (`server.ts`), в Go-клиенте полностью отсутствуют методы сбора и отправки метрик (`recordCodeAssistMetrics`, `recordConversationOffered`).

**Влияние**:
Сервер Google не получает данные об использовании инструмента, что может негативно сказаться на квотах, доступе к приватным превью-функциям и общей "репутации" клиента.

### 2.2. Отсутствие проверки Onboarding
**Проблема**:
Отсутствует проверка статуса пользователя через `onboardUser` перед началом работы. TypeScript-клиент проверяет, принял ли пользователь условия использования (TOS).

**Влияние**:
Новые пользователи могут столкнуться с неочевидными ошибками API, если они еще не приняли условия использования через другой интерфейс.

## 3. План исправлений

1.  **OAuth**: Реализовать `PersistingTokenSource`.
2.  **Client**: Внедрить динамическое определение `Platform`.
3.  **Metrics**: Добавить минимальную тулинг для отправки `ConversationOffered`.
